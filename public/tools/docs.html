<!-- public/tools/docs.html -->
<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="noindex,nofollow" />
<title>SPST • Utility Documenti</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui,Arial;margin:24px;background:#0b1220;color:#e7ecf5}
  .card{max-width:720px;margin:0 auto;background:#111a2b;border:1px solid #1f2a44;border-radius:14px;padding:18px}
  h1{font-size:18px;margin:0 0 12px}
  label{font-size:13px;color:#a9b3c7}
  input,select{width:100%;height:40px;border-radius:10px;border:1px solid #2a385a;background:#0f1627;color:#e7ecf5;padding:0 12px}
  .row{display:grid;grid-template-columns:1fr 180px;gap:10px}
  .small{color:#93a0bb;font-size:12px;margin-top:8px}
  button{height:40px;border-radius:10px;border:1px solid #f59e0b;background:#f59e0b;color:#111;font-weight:700;cursor:pointer}
  .out{margin-top:14px;white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a0f1c;border:1px solid #1f2a44;border-radius:10px;padding:10px}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="card">
    <h1>Utility Documenti (Proforma / DLE / Fattura)</h1>
    <div style="display:grid;gap:12px">
      <div>
        <label>ID Spedizione (record Airtable o ID Business)</label>
        <input id="sid" placeholder="recXXXXXXXXXXXX oppure ID Spedizione" />
      </div>

      <div class="row">
        <div>
          <label>Tipo documento</label>
          <select id="dtype">
            <option value="proforma">Proforma</option>
            <option value="dle">Dich. Esportazione (DLE)</option>
            <option value="invoice">Fattura (Commercial Invoice)</option>
          </select>
        </div>
        <div>
          <label>Admin key (opz.)</label>
          <input id="akey" placeholder="(se impostata in Vercel)" />
        </div>
      </div>

      <!-- Override/Template Corriere: visibile per Proforma e DLE -->
      <div id="carrier-wrap">
        <label>Corriere — Proforma: override · DLE: scegli template (FedEx/UPS)</label>
        <select id="carrier">
          <option value="">Usa valore da Airtable / Generico</option>
          <option value="fedex">FedEx</option>
          <option value="ups">UPS</option>
          <option value="dhl">DHL</option>
          <option value="gls">GLS</option>
          <option value="brt">BRT</option>
          <option value="altro">Altro…</option>
        </select>
      </div>

      <!-- Campo libero che appare se selezioni "Altro" -->
      <div id="carrier-other-wrap" class="hidden">
        <label>Specificare corriere</label>
        <input id="carrier-other" placeholder="Es. TNT, ChronoExpress, ecc." />
      </div>

      <button id="go">Genera e allega</button>
      <div id="out" class="out"></div>
      <div class="small">
        Nota: l’URL firmato scade in ~10 minuti. Per DLE: se selezioni <b>FedEx</b> o <b>UPS</b> verrà usato il relativo template HTML; altrimenti verrà usato il modello generico.
      </div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);

const dtype = $('#dtype');
const carrierWrap = $('#carrier-wrap');
const carrierSel = $('#carrier');
const carrierOtherWrap = $('#carrier-other-wrap');
const carrierOther = $('#carrier-other');

function syncCarrierVisibility(){
  const t = dtype.value;
  // mostra per proforma e DLE; non serve per la fattura
  const needsCarrier = (t === 'proforma' || t === 'dle');
  carrierWrap.classList.toggle('hidden', !needsCarrier);
  if (!needsCarrier){
    carrierSel.value = '';
    carrierOtherWrap.classList.add('hidden');
    carrierOther.value = '';
  }
}
dtype.addEventListener('change', syncCarrierVisibility);
syncCarrierVisibility();

carrierSel.addEventListener('change', () => {
  const needOther = carrierSel.value === 'altro';
  carrierOtherWrap.classList.toggle('hidden', !needOther);
  if (!needOther) carrierOther.value = '';
});

$('#go').addEventListener('click', async () => {
  const sid = $('#sid').value.trim();
  const type = dtype.value; // 'proforma' | 'dle' | 'invoice'
  const akey = $('#akey').value.trim();

  let carrier = '';
  if (type === 'proforma' || type === 'dle') {
    // valore select/other → normalizza a lowercase
    const sel = carrierSel.value;
    carrier = (sel === 'altro' ? carrierOther.value : sel).trim().toLowerCase();
    // per DLE consideriamo solo fedex/ups; altri valori vengono ignorati (usa generico o da Airtable)
    if (type === 'dle' && carrier && !['fedex','ups'].includes(carrier)) {
      carrier = '';
    }
  }

  $('#out').textContent = 'Invio richiesta…';
  try{
    const payload = { idSpedizione: sid, type };
    if (carrier) payload.carrier = carrier; // override/template opzionale

    const r = await fetch('/api/docs/unified/generate', {
      method:'POST',
      headers: Object.assign({'Content-Type':'application/json'}, akey ? {'x-admin-key': akey} : {}),
      body: JSON.stringify(payload)
    });

    const j = await r.json().catch(()=> ({}));
    if (!r.ok || !j.ok) throw new Error(j.error || ('HTTP '+r.status));

    $('#out').textContent = [
      'OK ✓ Documento: ', type,
      '\nCampo Airtable: ', j.field,
      '\nURL firmato: ', j.url,
      '\nApri il link per anteprima/stampa. Su Airtable l’allegato apparirà a breve.'
    ].join('');

    window.open(j.url, '_blank');
  }catch(e){
    $('#out').textContent = 'Errore: ' + (e.message || e);
  }
});
</script>
</body>
</html>
